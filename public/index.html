<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Status | basedsecurity.net</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x1F7E2;</text></svg>">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #111111;
      --bg-tertiary: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #888888;
      --text-muted: #555555;
      --border-color: #222222;
      --green: #00d26a;
      --green-dim: rgba(0, 210, 106, 0.1);
      --yellow: #ffc107;
      --yellow-dim: rgba(255, 193, 7, 0.1);
      --red: #ff4757;
      --red-dim: rgba(255, 71, 87, 0.1);
      --blue: #3b82f6;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .logo span {
      color: var(--green);
    }

    header p {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .overall-status {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 32px;
      text-align: center;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .status-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-dot.operational { background: var(--green); }
    .status-dot.degraded { background: var(--yellow); animation: none; }
    .status-dot.major_outage { background: var(--red); animation: none; }
    .status-dot.loading { background: var(--text-muted); animation: blink 1s infinite; }

    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(0, 210, 106, 0.4); }
      50% { opacity: 0.8; box-shadow: 0 0 0 8px rgba(0, 210, 106, 0); }
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .last-updated {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-top: 12px;
    }

    .category {
      margin-bottom: 24px;
    }

    .category-header {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      padding-left: 4px;
    }

    .services-list {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
    }

    .service-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      transition: background 0.2s;
    }

    .service-item:last-child {
      border-bottom: none;
    }

    .service-item:hover {
      background: var(--bg-tertiary);
    }

    .service-info {
      flex: 1;
    }

    .service-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .service-name a {
      color: var(--text-primary);
      text-decoration: none;
    }

    .service-name a:hover {
      color: var(--blue);
    }

    .external-icon {
      width: 12px;
      height: 12px;
      opacity: 0.5;
    }

    .service-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .service-error {
      margin-top: 8px;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      border-left: 3px solid var(--red);
      font-size: 0.8rem;
    }

    .service-error.degraded {
      border-left-color: var(--yellow);
    }

    .service-error-header {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--red);
      font-weight: 600;
      margin-bottom: 4px;
    }

    .service-error.degraded .service-error-header {
      color: var(--yellow);
    }

    .service-error-message {
      color: var(--text-secondary);
      word-break: break-word;
    }

    .service-error-details {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid var(--border-color);
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 0.75rem;
      color: var(--text-muted);
      word-break: break-all;
      max-height: 80px;
      overflow-y: auto;
    }

    .service-error-icon {
      width: 14px;
      height: 14px;
    }

    .service-status {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .response-time {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-family: 'SF Mono', Monaco, monospace;
      min-width: 60px;
      text-align: right;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .status-badge.operational {
      background: var(--green-dim);
      color: var(--green);
    }

    .status-badge.degraded {
      background: var(--yellow-dim);
      color: var(--yellow);
    }

    .status-badge.major_outage {
      background: var(--red-dim);
      color: var(--red);
    }

    .status-badge .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .incident-history {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-top: 32px;
    }

    .incident-header {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .incident-count {
      font-size: 0.8rem;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .incident-count.active {
      background: var(--red-dim);
      color: var(--red);
    }

    .no-incidents {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .incident-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .incident-item {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }

    .incident-item.active {
      border-color: var(--red);
    }

    .incident-item.resolved {
      opacity: 0.7;
    }

    .incident-title-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      cursor: pointer;
    }

    .incident-title-bar:hover {
      background: var(--bg-primary);
    }

    .incident-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .incident-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .incident-status-dot.major_outage { background: var(--red); }
    .incident-status-dot.degraded { background: var(--yellow); }
    .incident-status-dot.resolved { background: var(--green); }

    .incident-time {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .incident-details {
      padding: 16px;
      display: none;
    }

    .incident-item.expanded .incident-details {
      display: block;
    }

    .incident-meta {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .incident-updates {
      border-left: 2px solid var(--border-color);
      padding-left: 16px;
      margin-left: 4px;
    }

    .incident-update {
      position: relative;
      padding-bottom: 12px;
    }

    .incident-update:last-child {
      padding-bottom: 0;
    }

    .incident-update::before {
      content: '';
      position: absolute;
      left: -21px;
      top: 6px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: 2px solid var(--text-muted);
    }

    .incident-update.operational::before {
      border-color: var(--green);
      background: var(--green);
    }

    .incident-update.major_outage::before {
      border-color: var(--red);
      background: var(--red);
    }

    .incident-update.degraded::before {
      border-color: var(--yellow);
      background: var(--yellow);
    }

    .incident-update-time {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .incident-update-message {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .expand-icon {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .incident-item.expanded .expand-icon {
      transform: rotate(180deg);
    }

    footer {
      text-align: center;
      margin-top: 48px;
      padding-top: 24px;
      border-top: 1px solid var(--border-color);
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    footer a {
      color: var(--text-secondary);
      text-decoration: none;
    }

    footer a:hover {
      color: var(--text-primary);
    }

    .refresh-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .refresh-btn:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--text-muted);
    }

    .refresh-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .refresh-btn svg {
      width: 14px;
      height: 14px;
    }

    .refresh-btn.loading svg {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: var(--red-dim);
      border: 1px solid rgba(255, 71, 87, 0.3);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      color: var(--red);
      text-align: center;
    }

    /* System Stats Styles */
    .system-stats {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 32px;
    }

    .system-stats-header {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .system-hostname {
      font-size: 0.8rem;
      font-weight: 500;
      padding: 2px 10px;
      border-radius: 10px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-family: 'SF Mono', Monaco, monospace;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 16px;
    }

    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .stat-value.good { color: var(--green); }
    .stat-value.warning { color: var(--yellow); }
    .stat-value.critical { color: var(--red); }

    .stat-details {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .stat-details.docker-mem {
      font-size: 0.75rem;
      color: var(--blue);
      margin-top: 2px;
    }

    .bar-legend {
      display: flex;
      gap: 12px;
      margin-top: 6px;
      font-size: 0.7rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--text-secondary);
    }

    .legend-color {
      width: 8px;
      height: 8px;
      border-radius: 2px;
    }

    .legend-color.used {
      background: var(--green);
    }

    .legend-color.docker {
      background: var(--blue);
    }

    .stat-bar {
      height: 6px;
      background: var(--bg-primary);
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
    }

    .stat-bar.layered {
      position: relative;
      height: 10px;
    }

    .stat-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .stat-bar.layered .stat-bar-fill {
      position: absolute;
      top: 0;
      left: 0;
    }

    .stat-bar-docker {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: var(--blue);
      border-radius: 3px;
      transition: width 0.3s ease;
      opacity: 0.9;
    }

    .stat-bar-fill.good { background: var(--green); }
    .stat-bar-fill.warning { background: var(--yellow); }
    .stat-bar-fill.critical { background: var(--red); }

    .load-averages {
      display: flex;
      gap: 16px;
      font-size: 0.85rem;
    }

    .load-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .load-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .load-value {
      font-weight: 600;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .containers-section {
      margin-top: 20px;
      border-top: 1px solid var(--border-color);
      padding-top: 16px;
    }

    .containers-header {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .container-count {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--bg-tertiary);
      color: var(--text-muted);
    }

    .containers-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 8px;
    }

    .container-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-size: 0.85rem;
    }

    .container-name {
      font-family: 'SF Mono', Monaco, monospace;
      color: var(--text-primary);
      font-size: 0.8rem;
    }

    .container-stats {
      display: flex;
      gap: 12px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-family: 'SF Mono', Monaco, monospace;
    }

    /* Server Stats Container */
    #servers-stats-container {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .server-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    .server-unavailable {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 24px;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .unavailable-icon {
      font-size: 1.2rem;
      color: var(--yellow);
    }

    /* GPU Section Styles */
    .gpu-section {
      margin-top: 20px;
      border-top: 1px solid var(--border-color);
      padding-top: 16px;
    }

    .gpu-header {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .gpu-count {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--bg-tertiary);
      color: var(--text-muted);
    }

    .gpu-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .gpu-card {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 16px;
    }

    .gpu-name {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .gpu-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
    }

    .gpu-stat {
      display: flex;
      flex-direction: column;
    }

    .gpu-stat-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .gpu-stat-value {
      font-size: 1.1rem;
      font-weight: 600;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .gpu-stat-value.good { color: var(--green); }
    .gpu-stat-value.warning { color: var(--yellow); }
    .gpu-stat-value.critical { color: var(--red); }

    .gpu-bar {
      height: 4px;
      background: var(--bg-primary);
      border-radius: 2px;
      margin-top: 6px;
      overflow: hidden;
    }

    .gpu-bar-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .gpu-bar-fill.good { background: var(--green); }
    .gpu-bar-fill.warning { background: var(--yellow); }
    .gpu-bar-fill.critical { background: var(--red); }

    @media (max-width: 600px) {
      .service-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .service-status {
        width: 100%;
        justify-content: space-between;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .containers-list {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">based<span>security</span>.net</div>
      <p>Service Status Dashboard</p>
    </header>

    <div class="overall-status">
      <div class="status-indicator">
        <div class="status-dot loading" id="overall-dot"></div>
        <span id="overall-text">Checking systems...</span>
      </div>
      <div class="last-updated">
        <span id="last-updated">Fetching status...</span>
        <button class="refresh-btn" id="refresh-btn" onclick="fetchStatus()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 2v6h-6"></path>
            <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
            <path d="M3 22v-6h6"></path>
            <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
          </svg>
          Refresh
        </button>
      </div>
    </div>

    <div id="servers-stats-container">
      <!-- Cloud Server Stats -->
      <div class="system-stats" id="cloud-stats">
        <div class="system-stats-header">
          <span class="server-title">Cloud Server (AWS)</span>
          <span class="system-hostname" id="cloud-hostname">Loading...</span>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">CPU Usage</div>
            <div class="stat-value" id="cloud-cpu-value">--%</div>
            <div class="stat-details" id="cloud-cpu-details">-- cores</div>
            <div class="stat-bar"><div class="stat-bar-fill" id="cloud-cpu-bar" style="width: 0%"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Memory</div>
            <div class="stat-value" id="cloud-mem-value">--%</div>
            <div class="stat-details" id="cloud-mem-details">-- / --</div>
            <div class="stat-bar"><div class="stat-bar-fill" id="cloud-mem-bar" style="width: 0%"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Disk</div>
            <div class="stat-value" id="cloud-disk-value">--%</div>
            <div class="stat-details" id="cloud-disk-details">-- / --</div>
            <div class="stat-bar"><div class="stat-bar-fill" id="cloud-disk-bar" style="width: 0%"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Uptime</div>
            <div class="stat-value" id="cloud-uptime-value">--</div>
            <div class="stat-details">
              <div class="load-averages">
                <div class="load-item"><span class="load-label">1m</span><span class="load-value" id="cloud-load-1m">--</span></div>
                <div class="load-item"><span class="load-label">5m</span><span class="load-value" id="cloud-load-5m">--</span></div>
                <div class="load-item"><span class="load-label">15m</span><span class="load-value" id="cloud-load-15m">--</span></div>
              </div>
            </div>
          </div>
        </div>
        <div class="containers-section" id="cloud-containers-section" style="display: none;">
          <div class="containers-header">
            Docker Containers
            <span class="container-count" id="cloud-container-count">0</span>
          </div>
          <div class="containers-list" id="cloud-containers-list"></div>
        </div>
      </div>

      <!-- Home Server Stats -->
      <div class="system-stats" id="home-stats">
        <div class="system-stats-header">
          <span class="server-title">Home Server</span>
          <span class="system-hostname" id="home-hostname">Loading...</span>
        </div>
        <div class="server-unavailable" id="home-unavailable" style="display: none;">
          <span class="unavailable-icon">⚠</span>
          <span>Home server stats unavailable</span>
        </div>
        <div id="home-stats-content">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">CPU Usage</div>
              <div class="stat-value" id="home-cpu-value">--%</div>
              <div class="stat-details" id="home-cpu-details">-- cores</div>
              <div class="stat-bar"><div class="stat-bar-fill" id="home-cpu-bar" style="width: 0%"></div></div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Memory</div>
              <div class="stat-value" id="home-mem-value">--%</div>
              <div class="stat-details" id="home-mem-details">-- / --</div>
              <div class="stat-details docker-mem" id="home-docker-mem">Docker: --</div>
              <div class="stat-bar layered">
                <div class="stat-bar-fill" id="home-mem-bar" style="width: 0%"></div>
                <div class="stat-bar-docker" id="home-docker-bar" style="width: 0%"></div>
              </div>
              <div class="bar-legend">
                <span class="legend-item"><span class="legend-color used"></span>System</span>
                <span class="legend-item"><span class="legend-color docker"></span>Docker</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Disk</div>
              <div class="stat-value" id="home-disk-value">--%</div>
              <div class="stat-details" id="home-disk-details">-- / --</div>
              <div class="stat-bar"><div class="stat-bar-fill" id="home-disk-bar" style="width: 0%"></div></div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Uptime</div>
              <div class="stat-value" id="home-uptime-value">--</div>
              <div class="stat-details">
                <div class="load-averages">
                  <div class="load-item"><span class="load-label">1m</span><span class="load-value" id="home-load-1m">--</span></div>
                  <div class="load-item"><span class="load-label">5m</span><span class="load-value" id="home-load-5m">--</span></div>
                  <div class="load-item"><span class="load-label">15m</span><span class="load-value" id="home-load-15m">--</span></div>
                </div>
              </div>
            </div>
          </div>
          <div class="gpu-section" id="home-gpu-section" style="display: none;">
            <div class="gpu-header">
              GPU
              <span class="gpu-count" id="home-gpu-count">0</span>
            </div>
            <div class="gpu-list" id="home-gpu-list"></div>
          </div>
          <div class="containers-section" id="home-containers-section" style="display: none;">
            <div class="containers-header">
              Docker Containers
              <span class="container-count" id="home-container-count">0</span>
            </div>
            <div class="containers-list" id="home-containers-list"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="error-container"></div>

    <div id="services-container">
      <!-- Services will be rendered here -->
    </div>

    <div class="incident-history">
      <div class="incident-header">
        <span>Recent Incidents</span>
        <span class="incident-count" id="incident-count">0</span>
      </div>
      <div id="incidents-container">
        <div class="no-incidents">Loading incidents...</div>
      </div>
    </div>

    <footer>
      <p>Powered by <a href="https://portfolio.basedsecurity.net" target="_blank">basedsecurity.net</a></p>
    </footer>
  </div>

  <script>
    const categories = {
      application: 'Applications',
      microservice: 'Microservices',
      infrastructure: 'Infrastructure',
      homeserver: 'Home Server'
    };

    const statusLabels = {
      operational: 'Operational',
      degraded: 'Degraded',
      major_outage: 'Major Outage'
    };

    const overallLabels = {
      operational: 'All Systems Operational',
      degraded: 'Partial System Outage',
      major_outage: 'Major System Outage'
    };

    function formatResponseTime(ms) {
      if (ms === null || ms === undefined) return '-';
      if (ms < 1000) return `${ms}ms`;
      return `${(ms / 1000).toFixed(2)}s`;
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function getStatusClass(value, warning = 70, critical = 90) {
      if (value >= critical) return 'critical';
      if (value >= warning) return 'warning';
      return 'good';
    }

    // Render stats for a single server (prefix = 'cloud' or 'home')
    function renderServerStats(stats, prefix) {
      if (!stats) return;

      // Hostname
      const hostnameEl = document.getElementById(`${prefix}-hostname`);
      if (hostnameEl) {
        hostnameEl.textContent = `${stats.hostname || 'Unknown'} (${stats.platform || '?'}/${stats.arch || '?'})`;
      }

      // CPU
      const cpuUsage = stats.cpu?.usage || 0;
      const cpuClass = getStatusClass(cpuUsage);
      const cpuValueEl = document.getElementById(`${prefix}-cpu-value`);
      if (cpuValueEl) {
        cpuValueEl.textContent = `${cpuUsage}%`;
        cpuValueEl.className = `stat-value ${cpuClass}`;
      }
      const cpuDetailsEl = document.getElementById(`${prefix}-cpu-details`);
      if (cpuDetailsEl) {
        cpuDetailsEl.textContent = `${stats.cpu?.cores || 0} cores`;
      }
      const cpuBarEl = document.getElementById(`${prefix}-cpu-bar`);
      if (cpuBarEl) {
        cpuBarEl.style.width = `${cpuUsage}%`;
        cpuBarEl.className = `stat-bar-fill ${cpuClass}`;
      }

      // Memory
      const memUsage = stats.memory?.usage || 0;
      const memClass = getStatusClass(memUsage);
      const memValueEl = document.getElementById(`${prefix}-mem-value`);
      if (memValueEl) {
        memValueEl.textContent = `${memUsage}%`;
        memValueEl.className = `stat-value ${memClass}`;
      }
      const memDetailsEl = document.getElementById(`${prefix}-mem-details`);
      if (memDetailsEl) {
        memDetailsEl.textContent = `${formatBytes(stats.memory?.used || 0)} / ${formatBytes(stats.memory?.total || 0)}`;
      }
      // Docker memory (home server only)
      const dockerMemEl = document.getElementById(`${prefix}-docker-mem`);
      const dockerBarEl = document.getElementById(`${prefix}-docker-bar`);
      if (dockerMemEl && stats.memory?.dockerUsed !== undefined) {
        dockerMemEl.textContent = `Docker: ${formatBytes(stats.memory.dockerUsed)}`;
        dockerMemEl.style.display = 'block';
        // Calculate Docker usage as percentage of total
        if (dockerBarEl && stats.memory.total > 0) {
          const dockerPercent = (stats.memory.dockerUsed / stats.memory.total) * 100;
          dockerBarEl.style.width = `${dockerPercent}%`;
        }
      } else if (dockerMemEl) {
        dockerMemEl.style.display = 'none';
        if (dockerBarEl) dockerBarEl.style.width = '0%';
      }
      const memBarEl = document.getElementById(`${prefix}-mem-bar`);
      if (memBarEl) {
        memBarEl.style.width = `${memUsage}%`;
        memBarEl.className = `stat-bar-fill ${memClass}`;
      }

      // Disk
      const diskUsage = stats.disk?.usage || 0;
      const diskClass = getStatusClass(diskUsage, 80, 95);
      const diskValueEl = document.getElementById(`${prefix}-disk-value`);
      if (diskValueEl) {
        diskValueEl.textContent = `${diskUsage}%`;
        diskValueEl.className = `stat-value ${diskClass}`;
      }
      const diskDetailsEl = document.getElementById(`${prefix}-disk-details`);
      if (diskDetailsEl) {
        diskDetailsEl.textContent = `${formatBytes(stats.disk?.used || 0)} / ${formatBytes(stats.disk?.total || 0)}`;
      }
      const diskBarEl = document.getElementById(`${prefix}-disk-bar`);
      if (diskBarEl) {
        diskBarEl.style.width = `${diskUsage}%`;
        diskBarEl.className = `stat-bar-fill ${diskClass}`;
      }

      // Uptime
      const uptimeValueEl = document.getElementById(`${prefix}-uptime-value`);
      if (uptimeValueEl) {
        uptimeValueEl.textContent = stats.uptimeFormatted || '--';
        uptimeValueEl.className = 'stat-value good';
      }

      // Load averages
      const load1mEl = document.getElementById(`${prefix}-load-1m`);
      if (load1mEl) load1mEl.textContent = stats.loadAverage?.['1m'] || '--';
      const load5mEl = document.getElementById(`${prefix}-load-5m`);
      if (load5mEl) load5mEl.textContent = stats.loadAverage?.['5m'] || '--';
      const load15mEl = document.getElementById(`${prefix}-load-15m`);
      if (load15mEl) load15mEl.textContent = stats.loadAverage?.['15m'] || '--';

      // GPU stats (only for home server typically)
      const gpus = stats.gpu || [];
      const gpuSection = document.getElementById(`${prefix}-gpu-section`);
      const gpuList = document.getElementById(`${prefix}-gpu-list`);
      const gpuCount = document.getElementById(`${prefix}-gpu-count`);

      if (gpuSection && gpuList && gpuCount) {
        if (gpus.length > 0) {
          gpuSection.style.display = 'block';
          gpuCount.textContent = gpus.length;
          gpuList.innerHTML = gpus.map(gpu => {
            const usageClass = getStatusClass(gpu.usage);
            const memClass = getStatusClass(gpu.memoryUsage);
            const tempClass = gpu.temperature >= 85 ? 'critical' : (gpu.temperature >= 70 ? 'warning' : 'good');
            return `
              <div class="gpu-card">
                <div class="gpu-name">${escapeHtml(gpu.name)}</div>
                <div class="gpu-stats-grid">
                  <div class="gpu-stat">
                    <span class="gpu-stat-label">GPU Usage</span>
                    <span class="gpu-stat-value ${usageClass}">${gpu.usage}%</span>
                    <div class="gpu-bar"><div class="gpu-bar-fill ${usageClass}" style="width: ${gpu.usage}%"></div></div>
                  </div>
                  <div class="gpu-stat">
                    <span class="gpu-stat-label">VRAM</span>
                    <span class="gpu-stat-value ${memClass}">${gpu.memoryUsage}%</span>
                    <div class="gpu-bar"><div class="gpu-bar-fill ${memClass}" style="width: ${gpu.memoryUsage}%"></div></div>
                  </div>
                  <div class="gpu-stat">
                    <span class="gpu-stat-label">Temperature</span>
                    <span class="gpu-stat-value ${tempClass}">${gpu.temperature}°C</span>
                  </div>
                  <div class="gpu-stat">
                    <span class="gpu-stat-label">Power</span>
                    <span class="gpu-stat-value">${gpu.powerDraw.toFixed(0)}W</span>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        } else {
          gpuSection.style.display = 'none';
        }
      }

      // Docker containers
      const containers = stats.containers || [];
      const containersSection = document.getElementById(`${prefix}-containers-section`);
      const containersList = document.getElementById(`${prefix}-containers-list`);
      const containerCount = document.getElementById(`${prefix}-container-count`);

      if (containersSection && containersList && containerCount) {
        if (containers.length > 0) {
          containersSection.style.display = 'block';
          containerCount.textContent = containers.length;
          containersList.innerHTML = containers.map(c => `
            <div class="container-item">
              <span class="container-name">${escapeHtml(c.name)}</span>
              <div class="container-stats">
                <span>CPU: ${c.cpu.toFixed(1)}%</span>
                <span>MEM: ${c.memPercent.toFixed(1)}%</span>
              </div>
            </div>
          `).join('');
        } else {
          containersSection.style.display = 'none';
        }
      }
    }

    // Render all server stats (cloud + home)
    function renderAllServerStats(data) {
      if (!data) return;

      // Render cloud server stats
      if (data.cloud) {
        renderServerStats(data.cloud, 'cloud');
      }

      // Render home server stats
      const homeUnavailable = document.getElementById('home-unavailable');
      const homeStatsContent = document.getElementById('home-stats-content');

      if (data.home && data.home.available) {
        if (homeUnavailable) homeUnavailable.style.display = 'none';
        if (homeStatsContent) homeStatsContent.style.display = 'block';
        renderServerStats(data.home, 'home');
      } else {
        if (homeUnavailable) homeUnavailable.style.display = 'flex';
        if (homeStatsContent) homeStatsContent.style.display = 'none';
      }
    }

    async function fetchSystemStats() {
      try {
        const basePath = window.location.pathname.startsWith('/status') ? '/status' : '';
        const response = await fetch(basePath + '/api/servers');
        if (response.ok) {
          const stats = await response.json();
          renderAllServerStats(stats);
        }
      } catch (error) {
        console.error('Failed to fetch server stats:', error);
      }
    }

    function formatTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function getDiagnosis(service) {
      const error = service.error || '';
      const message = service.message || '';

      // Analyze error patterns and provide helpful diagnosis
      if (error.includes('ENOTFOUND') || error.includes('getaddrinfo')) {
        return 'DNS resolution failed - the hostname cannot be resolved. Check if the service is running and DNS is configured correctly.';
      }
      if (error.includes('ECONNREFUSED')) {
        return 'Connection refused - the service is not accepting connections. The server may be down or the port may be blocked.';
      }
      if (error.includes('ETIMEDOUT') || error.includes('timeout') || message.includes('timeout')) {
        return 'Request timed out - the service is not responding in time. May indicate high load or network issues.';
      }
      if (error.includes('ECONNRESET')) {
        return 'Connection reset - the server closed the connection unexpectedly. May indicate a crash or restart.';
      }
      if (error.includes('SSL') || error.includes('TLS') || error.includes('certificate') || error.includes('EPROTO')) {
        return 'SSL/TLS error - there is a problem with the secure connection. Check certificate validity and configuration.';
      }
      if (error.includes('401') || error.includes('Unauthorized')) {
        return 'Authentication failed - credentials may be invalid or expired.';
      }
      if (error.includes('403') || error.includes('Forbidden')) {
        return 'Access denied - the service is rejecting requests. Check permissions and firewall rules.';
      }
      if (error.includes('404') || message.includes('404')) {
        return 'Endpoint not found - the health check URL may be incorrect or the service is misconfigured.';
      }
      if (error.includes('500') || error.includes('502') || error.includes('503')) {
        return 'Server error - the service encountered an internal error. Check server logs for details.';
      }
      if (message === 'Service unavailable') {
        return 'The service health check returned an error response. The service may be starting up or experiencing issues.';
      }

      return null;
    }

    function renderErrorDetails(service) {
      const diagnosis = getDiagnosis(service);
      const errorClass = service.status === 'degraded' ? 'degraded' : '';
      const iconColor = service.status === 'degraded' ? 'var(--yellow)' : 'var(--red)';

      let html = `<div class="service-error ${errorClass}">`;
      html += `<div class="service-error-header">
        <svg class="service-error-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        ${service.message || 'Unknown error'}
      </div>`;

      if (diagnosis) {
        html += `<div class="service-error-message">${diagnosis}</div>`;
      }

      if (service.error) {
        html += `<div class="service-error-details">${escapeHtml(service.error)}</div>`;
      }

      html += '</div>';
      return html;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function renderServices(services) {
      const container = document.getElementById('services-container');
      const grouped = {};

      // Group by category
      services.forEach(service => {
        const cat = service.category || 'other';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(service);
      });

      let html = '';

      // Render in order: application, microservice, infrastructure
      ['application', 'microservice', 'infrastructure', 'homeserver'].forEach(category => {
        if (!grouped[category]) return;

        html += `
          <div class="category">
            <div class="category-header">${categories[category] || category}</div>
            <div class="services-list">
              ${grouped[category].map(service => `
                <div class="service-item">
                  <div class="service-info">
                    <div class="service-name">
                      ${service.publicUrl
                        ? `<a href="${service.publicUrl}" target="_blank">${service.name}</a>
                           <svg class="external-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                             <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                             <polyline points="15 3 21 3 21 9"></polyline>
                             <line x1="10" y1="14" x2="21" y2="3"></line>
                           </svg>`
                        : service.name
                      }
                    </div>
                    <div class="service-description">${service.description}</div>
                    ${service.status !== 'operational' ? renderErrorDetails(service) : ''}
                  </div>
                  <div class="service-status">
                    <div class="response-time">${formatResponseTime(service.responseTime)}</div>
                    <div class="status-badge ${service.status}">
                      <span class="dot"></span>
                      ${statusLabels[service.status] || service.status}
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function updateOverallStatus(status) {
      const dot = document.getElementById('overall-dot');
      const text = document.getElementById('overall-text');

      dot.className = `status-dot ${status}`;
      text.textContent = overallLabels[status] || status;
    }

    function showError(message) {
      const container = document.getElementById('error-container');
      container.innerHTML = `<div class="error-message">${message}</div>`;
    }

    function clearError() {
      document.getElementById('error-container').innerHTML = '';
    }

    function formatDateTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatDuration(startDate, endDate) {
      const start = new Date(startDate);
      const end = endDate ? new Date(endDate) : new Date();
      const diff = end - start;

      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (days > 0) return `${days}d ${hours % 24}h`;
      if (hours > 0) return `${hours}h ${minutes % 60}m`;
      return `${minutes}m`;
    }

    function toggleIncident(element) {
      element.closest('.incident-item').classList.toggle('expanded');
    }

    function renderIncidents(incidents) {
      const container = document.getElementById('incidents-container');
      const countEl = document.getElementById('incident-count');

      const activeIncidents = incidents.filter(i => !i.resolvedAt);
      const recentIncidents = incidents.slice(0, 10); // Show last 10

      // Update count badge
      if (activeIncidents.length > 0) {
        countEl.textContent = `${activeIncidents.length} Active`;
        countEl.classList.add('active');
      } else {
        countEl.textContent = incidents.length;
        countEl.classList.remove('active');
      }

      if (recentIncidents.length === 0) {
        container.innerHTML = '<div class="no-incidents">No incidents reported in the last 90 days.</div>';
        return;
      }

      let html = '<div class="incident-list">';

      recentIncidents.forEach(incident => {
        const isResolved = !!incident.resolvedAt;
        const statusClass = isResolved ? 'resolved' : 'active';
        const dotClass = isResolved ? 'resolved' : incident.status;
        const duration = formatDuration(incident.startedAt, incident.resolvedAt);

        html += `
          <div class="incident-item ${statusClass}">
            <div class="incident-title-bar" onclick="toggleIncident(this)">
              <div class="incident-title">
                <span class="incident-status-dot ${dotClass}"></span>
                ${escapeHtml(incident.title)}
              </div>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span class="incident-time">${formatDateTime(incident.startedAt)}</span>
                <svg class="expand-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </div>
            </div>
            <div class="incident-details">
              <div class="incident-meta">
                <span>Service: ${escapeHtml(incident.serviceName)}</span>
                <span>Duration: ${duration}</span>
                <span>Status: ${isResolved ? 'Resolved' : (incident.status === 'major_outage' ? 'Major Outage' : 'Degraded')}</span>
              </div>
              <div class="incident-updates">
                ${incident.updates.slice().reverse().map(update => `
                  <div class="incident-update ${update.status}">
                    <div class="incident-update-time">${formatDateTime(update.timestamp)}</div>
                    <div class="incident-update-message">${escapeHtml(update.message)}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;
    }

    async function fetchStatus() {
      const btn = document.getElementById('refresh-btn');
      btn.disabled = true;
      btn.classList.add('loading');

      try {
        // Use relative path that works under /status prefix or root
        const basePath = window.location.pathname.startsWith('/status') ? '/status' : '';
        const response = await fetch(basePath + '/api/status');

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        clearError();
        updateOverallStatus(data.overallStatus);
        renderServices(data.services);
        renderIncidents(data.incidents || []);

        document.getElementById('last-updated').textContent =
          `Last updated: ${formatTime(data.timestamp)}`;

      } catch (error) {
        console.error('Failed to fetch status:', error);
        showError(`Failed to fetch status: ${error.message}`);
        updateOverallStatus('major_outage');
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
      }
    }

    // Initial fetch
    fetchStatus();
    fetchSystemStats();

    // Auto-refresh every 30 seconds
    setInterval(() => {
      fetchStatus();
      fetchSystemStats();
    }, 30000);
  </script>
</body>
</html>
